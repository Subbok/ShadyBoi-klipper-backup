####################################
#             INCLUDES 
####################################
[include mainsail.cfg]
[include KAMP_Settings.cfg]
[include ./CFG/macros.cfg]
[include ./CFG/led_effect.cfg]
[include ./CFG/tmc-autotune.cfg]
[include ./CFG/start_print.cfg]
[include ./CFG/probe.cfg]
#[include ./CFG/eddy.cfg]
#[include ./CFG/lis2dw.cfg]
#[include ./CFG/adxl345.cfg]

####################################
#          MISCELLANEOUS
####################################

[exclude_object]

[gcode_arcs]
resolution: 0.1

[firmware_retraction]
retract_length: 0.5
retract_speed: 45
unretract_extra_length: 0
unretract_speed: 20

#[input_shaper]
#shaper_freq_x: 59.4
#shaper_type_x: ei
#shaper_freq_y: 49.1
#shaper_type_y: ei

####################################
#               CORE
####################################

[mcu CB1]
serial: /tmp/klipper_host_mcu

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_420049000B504B5735313920-if00
restart_method: command

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_45503571290C0CF8-if00

[printer]
kinematics: cartesian
max_velocity: 300
max_z_velocity: 5
max_z_accel: 100
max_accel: 5000
square_corner_velocity: 5.0

####################################
#             FANS/TEMP
####################################

[fan]
pin: CB1: gpio79

[temperature_sensor CB1]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor MCU]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[heater_fan hotend_fan]
pin: PA3
max_power: 1.0
fan_speed: 1
kick_start_time: 0
heater: extruder
heater_temp: 50.0

####################################
#            STEPPERS
####################################

[stepper_x]
step_pin: PC8
dir_pin: !PC9
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^PD3
position_endstop: -3
position_min: -3
position_max: 243.5
homing_speed: 80
second_homing_speed: 20

[stepper_y]
step_pin: PA10
dir_pin: !PA14
enable_pin: !PA13
microsteps: 16
rotation_distance: 40
endstop_pin: ^PD2
position_endstop: 0
position_max: 230
homing_speed: 80
second_homing_speed: 20

[stepper_z]
step_pin: PC6
dir_pin: PC7
enable_pin: !PA9
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -6
position_max: 215
homing_speed: 100
second_homing_speed: 1
homing_retract_dist: 2.3

[stepper_z1]
step_pin: PB12
dir_pin: PB11
enable_pin: !PA8
microsteps: 16
rotation_distance: 8

[extruder]
step_pin: PB0
dir_pin: !PB1
enable_pin: !PC4
microsteps: 16
rotation_distance: 7.651
nozzle_diameter: 0.400
filament_diameter: 1.750
pressure_advance: 0.048
max_extrude_cross_section: 5

[tmc2209 stepper_x]
uart_pin: PD9
run_current: 0.650
hold_current: 0.500
interpolate: true

[tmc2209 stepper_y]
uart_pin: PD8
run_current: 0.650
hold_current: 0.500
interpolate: true

[tmc2209 stepper_z]
uart_pin: PB10
run_current: 0.650
hold_current: 0.500
interpolate: true

[tmc2209 stepper_z1]
uart_pin: PB2
run_current: 0.650
hold_current: 0.500
interpolate: true

[tmc2209 extruder]
uart_pin: PA6
run_current: 0.800
hold_current: 0.500

####################################
#            HEATERS
####################################

[extruder]
heater_pin: PC5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1
#control: pid
min_temp: -200
max_temp: 300
min_extrude_temp: 190

[heater_bed]
heater_pin: PA5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
#control: pid
min_temp: 0
max_temp: 130
pwm_cycle_time: 0.2

####################################
#               BED
####################################

[safe_z_home]
home_xy_position: 160,147.10
speed: 150
z_hop: 10
z_hop_speed: 25

[bed_mesh]
speed: 200
horizontal_move_z: 3.5
mesh_min: 13.5,22.5    
mesh_max: 204,221.5     
probe_count: 9
mesh_pps: 2,2
fade_start: 1
fade_end: 10
fade_target: 0
algorithm: bicubic
adaptive_margin: 5
zero_reference_position: 155,125

[z_tilt]
z_positions:
            240, 147.5
            95, 147.5
points:
            240, 147.5
            95, 147.5
speed: 400
horizontal_move_z: 3.5
retries: 20
retry_tolerance: .002

####################################
#              EDDY
####################################

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 100

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 1.5
i2c_mcu: eddy
i2c_bus: i2c0f
speed: 10
samples: 3
samples_tolerance: 0.01
samples_tolerance_retries: 3
x_offset: -42.5
y_offset: -30

[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
speed: 200
horizontal_move_z: 3.5

[force_move]
enable_force_move: True 

[gcode_macro G28]
rename_existing: G28.1
gcode:
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
    SET_Z_FROM_PROBE
  {% endif %}

[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}

[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False
variable_runtime_offset: 0
gcode:
  SET_GCODE_OFFSET_ORIG { rawparams }

[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 }
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.911
#*# pid_ki = 5.169
#*# pid_kd = 37.680
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.838
#*# pid_ki = 1.033
#*# pid_kd = 1283.765
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3211471.576,0.090000:3211331.504,0.130000:3211139.970,
#*# 	0.170000:3210862.527,0.210000:3210583.638,0.250000:3210256.238,
#*# 	0.290000:3209907.684,0.330000:3209462.893,0.370000:3208804.822,
#*# 	0.410000:3208148.473,0.450000:3207467.845,0.490000:3206842.423,
#*# 	0.530000:3206195.921,0.570000:3205551.576,0.610000:3204927.935,
#*# 	0.650000:3204320.753,0.690000:3203694.796,0.730000:3203082.683,
#*# 	0.770000:3202493.476,0.810000:3201900.611,0.850000:3201336.477,
#*# 	0.890000:3200759.441,0.930000:3200160.745,0.970000:3199588.964,
#*# 	1.010000:3199026.366,1.050000:3198478.350,1.090000:3197937.704,
#*# 	1.130000:3197391.689,1.170000:3196859.941,1.210000:3196339.663,
#*# 	1.250000:3195803.570,1.290000:3195284.302,1.330000:3194790.666,
#*# 	1.370000:3194257.101,1.410000:3193764.627,1.450000:3193278.084,
#*# 	1.490000:3192818.291,1.530000:3192322.598,1.570000:3191857.062,
#*# 	1.610000:3191404.661,1.650000:3190937.151,1.690000:3190458.780,
#*# 	1.730000:3190003.895,1.770000:3189563.081,1.810000:3189141.732,
#*# 	1.850000:3188683.480,1.890000:3188254.869,1.930000:3187838.929,
#*# 	1.970000:3187442.173,2.010000:3187041.255,2.050000:3186618.628,
#*# 	2.090000:3186259.234,2.130000:3185849.939,2.170000:3185468.592,
#*# 	2.210000:3185090.685,2.250000:3184720.945,2.290000:3184362.523,
#*# 	2.330000:3183988.869,2.370000:3183645.639,2.410000:3183287.559,
#*# 	2.450000:3182948.188,2.490000:3182593.934,2.530000:3182269.787,
#*# 	2.570000:3181934.766,2.610000:3181626.242,2.650000:3181286.707,
#*# 	2.690000:3180960.165,2.730000:3180678.136,2.770000:3180347.203,
#*# 	2.810000:3180049.377,2.850000:3179751.166,2.890000:3179469.667,
#*# 	2.930000:3179165.473,2.970000:3178887.211,3.010000:3178611.141,
#*# 	3.050000:3178286.726,3.090000:3178068.431,3.130000:3177784.229,
#*# 	3.170000:3177531.333,3.210000:3177269.725,3.250000:3177017.691,
#*# 	3.290000:3176743.673,3.330000:3176463.636,3.370000:3176268.126,
#*# 	3.410000:3176053.900,3.450000:3175780.431,3.490000:3175588.042,
#*# 	3.530000:3175329.534,3.570000:3175105.572,3.610000:3174854.457,
#*# 	3.650000:3174677.505,3.690000:3174406.496,3.730000:3174251.348,
#*# 	3.770000:3174033.909,3.810000:3173841.767,3.850000:3173624.158,
#*# 	3.890000:3173433.834,3.930000:3173247.827,3.970000:3173044.265,
#*# 	4.010000:3172844.087,4.050000:3172668.323
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 39.471914
#*# drift_calibration =
#*# 	3272025.098165, -1250.590980, 7.214985
#*# 	3243606.801532, -696.283693, 3.302789
#*# 	3229459.182838, -567.139734, 2.405697
#*# 	3216624.238994, -413.697391, 1.257959
#*# 	3204892.998998, -249.132146, 0.059735
#*# 	3194158.591156, -77.964740, -1.239916
#*# 	3185927.299623, 34.831304, -2.031537
#*# 	3179495.365077, 111.595788, -2.541786
#*# 	3174593.631963, 157.327172, -2.778488
#*# drift_calibration_min_temp = 39.14280522520138
